<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kollaborative Workshop-Listen (Echtzeit)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <style>
    /* Konfiguriere die Schriftart Inter */
    html {
      font-family: 'Inter', sans-serif;
    }

    .icon-size {
      width: 1.25rem;
      height: 1.25rem;
    }

    /* Stile für das Burger-Menü */
    #menu-sidebar {
      transition: transform 0.3s ease-in-out;
    }

    #menu-overlay {
      transition: opacity 0.3s ease-in-out;
    }

    /* Body-Klasse zum Öffnen des Menüs */
    body.menu-open #menu-sidebar {
      transform: translateX(0);
    }

    body.menu-open #menu-overlay {
      opacity: 1;
      pointer-events: auto;
    }
  </style>

</head>

<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

  <!-- Mobiles Menü (Sidebar) -->
  <div id="menu-sidebar"
    class="fixed inset-y-0 left-0 bg-white shadow-xl z-50 p-6 transform -translate-x-full">
    <h2 class="text-2xl font-bold text-indigo-800 mb-6">Navigation</h2>
    <nav>
      <!-- GEÄNDERT: 4 Menüpunkte -->
      <ul class="space-y-1">
        <li>
          <button id="menu-link-workshops-sa"
            class="w-full text-left flex items-center text-lg font-medium text-gray-700 hover:text-indigo-600 p-2 rounded-lg transition">
            <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
            Workshops (Sa)
          </button>
        </li>
        <li>
          <button id="menu-link-workshops-so"
            class="w-full text-left flex items-center text-lg font-medium text-gray-700 hover:text-indigo-600 p-2 rounded-lg transition">
            <i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>
            Workshops (So)
          </button>
        </li>
        <li>
          <button id="menu-link-sport-sa"
            class="w-full text-left flex items-center text-lg font-medium text-gray-700 hover:text-indigo-600 p-2 rounded-lg transition">
            <i data-lucide="weight-lifting" class="w-5 h-5 mr-3"></i>
            Sportangebote (Sa)
          </button>
        </li>
        <li>
          <button id="menu-link-sport-so"
            class="w-full text-left flex items-center text-lg font-medium text-gray-700 hover:text-indigo-600 p-2 rounded-lg transition">
            <i data-lucide="weight-lifting" class="w-5 h-5 mr-3"></i>
            Sportangebote (So)
          </button>
        </li>
      </ul>
    </nav>
  </div>

  <!-- Overlay zum Schließen des Menüs -->
  <div id="menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 opacity-0 pointer-events-none">
  </div>

  <div class="max-w-6xl mx-auto">
    <header class="text-center mb-10 p-6 bg-white rounded-xl shadow-lg border-t-4 border-indigo-500 relative">
      <!-- Burger-Menü Button -->
      <button id="menu-open-btn"
        class="absolute top-4 left-4 p-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
        <i data-lucide="menu" class="w-6 h-6"></i>
      </button>

      <!-- IDs 'main-title' und 'main-subtitle' hinzugefügt -->
      <!-- GEÄNDERT: Starttitel angepasst -->
      <h1 id="main-title" class="text-4xl font-extrabold text-indigo-800 mb-2">Workshops (Samstag)</h1>
      <p id="main-subtitle" class="text-xl text-gray-600 font-medium">Trage dich hier für die Workshops am Samstag ein
      </p>

      <button id="admin-login-btn"
        class="absolute top-4 right-4 px-3 py-1 bg-gray-200 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-300 transition flex items-center">
        <i data-lucide="lock" class="w-4 h-4 mr-1"></i>
        <span id="admin-status-text">Admin Login</span>
      </button>
    </header>

    <div id="admin-panel" class="hidden mb-10 p-6 bg-yellow-50 border border-yellow-300 rounded-xl shadow-md">
      <h2 class="text-2xl font-bold text-yellow-800 mb-4 flex items-center">
        <i data-lucide="shield" class="w-6 h-6 mr-2"></i>
        Administrator-Steuerung
      </h2>
      <p class="text-sm text-yellow-700 mb-4 font-medium">
        Sicherheitswarnung: Dieses Admin-Passwort ist hartkodiert und nur für Demos geeignet.
      </p>

      <form id="workshop-form" class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end p-4 bg-white rounded-lg border">
        <div class="md:col-span-1">
          <label for="form-id" class="block text-xs font-semibold text-gray-600 mb-1">ID (Eindeutig, z.B.
            beispiel_workshop)</label>
          <input type="text" id="form-id" required class="w-full p-2 border border-gray-300 rounded-lg text-sm">
        </div>
        <div class="md:col-span-1">
          <label for="form-title" class="block text-xs font-semibold text-gray-600 mb-1">Titel</label>
          <input type="text" id="form-title" required class="w-full p-2 border border-gray-300 rounded-lg text-sm">
        </div>
        <div class="md:col-span-1">
          <label for="form-date" class="block text-xs font-semibold text-gray-600 mb-1">Datum und Uhrzeit</label>
          <input type="datetime-local" id="form-date" required
            class="w-full p-2 border border-gray-300 rounded-lg text-sm">
        </div>
        <div class="md:col-span-1">
          <label for="form-location" class="block text-xs font-semibold text-gray-600 mb-1">Ort</label>
          <input type="text" id="form-location" class="w-full p-2 border border-gray-300 rounded-lg text-sm">
        </div>
        <div class="md:col-span-1">
          <label for="form-capacity" class="block text-xs font-semibold text-gray-600 mb-1">Max. Teilnehmer</label>
          <input type="number" id="form-capacity" required min="1"
            class="w-full p-2 border border-gray-300 rounded-lg text-sm">
        </div>
        <div class="md:col-span-1 flex space-x-2">
          <button type="submit" id="form-submit-btn"
            class="flex-grow px-4 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">
            Workshop Erstellen/Speichern
          </button>
        </div>
      </form>
      <p id="admin-status" class="mt-3 text-sm font-medium text-gray-700"></p>
    </div>


    <div id="workshops-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <div id="loading-workshops" class="md:col-span-full text-center p-10 text-indigo-600 font-semibold">
        <div class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-3"
          role="status"></div>
        <p>Lade Workshops...</p>
      </div>
    </div>

    <div id="global-error-message"
      class="hidden fixed bottom-4 right-4 p-4 bg-red-600 text-white rounded-lg shadow-xl font-medium z-50"></div>

    <div id="user-info-footer"
      class="hidden mt-8 text-center p-4 bg-gray-100 rounded-lg text-gray-600 text-sm break-all">
      <span class="font-semibold">App ID:</span> <span id="app-id-display"></span> |
      <span class="font-semibold">User ID:</span> <span id="user-id-display"></span>
    </div>
  </div>

  <div id="admin-login-modal"
    class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-2xl p-8 w-full max-w-sm">
      <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
        <i data-lucide="key" class="w-5 h-5 mr-2"></i> Admin Login
      </h3>
      <p class="text-gray-600 mb-6">Bitte geben Sie das Administrator-Passwort ein.</p>
      <input type="password" id="admin-password-input" placeholder="Passwort"
        class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-indigo-500 focus:border-indigo-500">
      <div id="admin-login-error" class="text-red-500 text-sm mb-4 hidden"></div>
      <div class="flex justify-end space-x-3">
        <button id="admin-modal-cancel-btn"
          class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Abbrechen</button>
        <button id="admin-modal-confirm-btn"
          class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">Anmelden</button>
      </div>
    </div>
  </div>

  <div id="confirm-modal"
    class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
      <h3 class="text-xl font-bold text-gray-800 mb-4">Aktion bestätigen</h3>
      <p id="modal-text" class="text-gray-600 mb-6">Möchten Sie den Eintrag wirklich löschen?</p>
      <div class="flex justify-end space-x-3">
        <button id="modal-cancel-btn"
          class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Abbrechen</button>
        <button id="modal-confirm-btn"
          class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 transition">Löschen</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Importiere notwendige Firebase-Module
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
      getFirestore, collection, doc,
      onSnapshot, setLogLevel,
      setDoc, updateDoc, arrayUnion, arrayRemove,
      getDoc, deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // *******************************************************************
    // SICHERHEITSWARNUNG: Dieses Passwort ist hartkodiert und nur für Demos!
    // *********************************G**********************************
    const ADMIN_PASSWORD = "workshopadmin";

    const YOUR_FIREBASE_CONFIG = {
      apiKey: "AIzaSyAm5Jo-J1K7kp-2ZjLS3uGIsCKrIDvdBp0",
      authDomain: "konfi-castle-workshops.firebaseapp.com",
      projectId: "konfi-castle-workshops",
      storageBucket: "konfi-castle-workshops.firebasestorage.app",
      messagingSenderId: "426392861731",
      appId: "1:426392861731:web:48277e7a085a3604500596",
      measurementId: "G-H96JTVKTNM"
    };

    // Globale Variablen aus der Canvas-Umgebung oder Fallback
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : YOUR_FIREBASE_CONFIG;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

    let app;
    let db;
    let auth;
    let userId = 'Gast-User';
    let isAuthReady = false;
    let isAdmin = false;

    // GEÄNDERT: Start-Collection ist 'workshops_sa'
    let currentCollectionId = 'workshops_sa';
    let workshopListenerUnsubscribe = null;

    // GEÄNDERT: Definition der 4 Collections und ihrer Titel
    const COLLECTION_TITLES = {
      'workshops_sa': 'Workshops (Samstag)',
      'workshops_so': 'Workshops (Sonntag)',
      'sport_sa': 'Sportangebote (Samstag)',
      'sport_so': 'Sportangebote (Sonntag)'
    };
    const COLLECTION_SUBTITLES = {
      'workshops_sa': 'Trage dich hier für die Workshops am Samstag ein',
      'workshops_so': 'Trage dich hier für die Workshops am Sonntag ein',
      'sport_sa': 'Trage dich hier für die Sportangebote am Samstag ein',
      'sport_so': 'Trage dich hier für die Sportangebote am Sonntag ein'
    };


    const workshopsContainer = document.getElementById('workshops-container');
    const globalErrorMessage = document.getElementById('global-error-message');
    const confirmModal = document.getElementById('confirm-modal');
    const modalText = document.getElementById('modal-text');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    const adminLoginBtn = document.getElementById('admin-login-btn');
    const adminStatusText = document.getElementById('admin-status-text');
    const adminLoginModal = document.getElementById('admin-login-modal');
    const adminPasswordInput = document.getElementById('admin-password-input');
    const adminModalConfirmBtn = document.getElementById('admin-modal-confirm-btn');
    const adminModalCancelBtn = document.getElementById('admin-modal-cancel-btn');
    const adminLoginError = document.getElementById('admin-login-error');
    const adminPanel = document.getElementById('admin-panel');
    const adminStatus = document.getElementById('admin-status');
    const workshopForm = document.getElementById('workshop-form');
    const formId = document.getElementById('form-id');
    const formTitle = document.getElementById('form-title');
    const formDate = document.getElementById('form-date');
    const formLocation = document.getElementById('form-location');
    const formCapacity = document.getElementById('form-capacity');

    // GEÄNDERT: DOM-Elemente für die 4 Menü-Buttons
    const menuOpenBtn = document.getElementById('menu-open-btn');
    const menuOverlay = document.getElementById('menu-overlay');
    const menuLinkWorkshopsSa = document.getElementById('menu-link-workshops-sa');
    const menuLinkWorkshopsSo = document.getElementById('menu-link-workshops-so');
    const menuLinkSportSa = document.getElementById('menu-link-sport-sa');
    const menuLinkSportSo = document.getElementById('menu-link-sport-so');


    document.getElementById('app-id-display').textContent = appId;


    // Statische Definition der Workshops (wird nur zur Initialisierung verwendet)
    // GEÄNDERT: Diese Daten gelten NUR für die 'workshops_sa' Collection
    const WORKSHOPS_STATIC_DATA = [
      { id: 'testWorkshop', title: 'Beispiel', date: '2025-12-17T14:30', location: 'Raum 101', maxParticipants: 12 }
    ];

    /**
     * Gibt den korrekten Firestore-Pfad für die ÖFFENTLICHE Workshop-Liste zurück.
     * Nutzt die globale Variable 'currentCollectionId'.
     */
    function getWorkshopsPath() {
      // GEÄNDERT: Fallback auf 'workshops_sa'
      const collectionName = currentCollectionId || 'workshops_sa';
      return `artifacts/${appId}/public/data/${collectionName}`;
    }

    // Konvertiert ISO Datum/Uhrzeit in deutsches Format
    function formatDateForDisplay(isoDateString) {
      if (!isoDateString || typeof isoDateString !== 'string') return 'Datum unbekannt';

      try {
        const date = new Date(isoDateString);
        return date.toLocaleString('de-DE', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
          weekday: 'long'
        });
      } catch (e) {
        console.error("Fehler beim Formatieren des Datums:", e);
        return isoDateString;
      }
    }


    /**
     * Zeigt eine benutzerdefinierte Fehlermeldung/Erfolgsmeldung an.
     */
    function showMessage(message, isError = true) {
      globalErrorMessage.textContent = message;
      globalErrorMessage.className = isError
        ? 'fixed bottom-4 right-4 p-4 bg-red-600 text-white rounded-lg shadow-xl font-medium z-50'
        : 'fixed bottom-4 right-4 p-4 bg-green-600 text-white rounded-lg shadow-xl font-medium z-50';
      globalErrorMessage.classList.remove('hidden');

      setTimeout(() => {
        globalErrorMessage.classList.add('hidden');
      }, 5000);
    }

    /**
     * Simuliert einen Bestätigungsdialog.
     */
    function showConfirmModal(message, isDanger = true) {
      return new Promise(resolve => {
        modalText.textContent = message;
        confirmModal.classList.remove('hidden');

        modalConfirmBtn.className = isDanger
          ? 'px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 transition'
          : 'px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition';

        const confirmListener = () => {
          confirmModal.classList.add('hidden');
          modalConfirmBtn.removeEventListener('click', confirmListener);
          modalCancelBtn.removeEventListener('click', cancelListener);
          resolve(true);
        };

        const cancelListener = () => {
          confirmModal.classList.add('hidden');
          modalConfirmBtn.removeEventListener('click', confirmListener);
          modalCancelBtn.removeEventListener('click', cancelListener);
          resolve(false);
        };

        modalConfirmBtn.addEventListener('click', confirmListener);
        modalCancelBtn.addEventListener('click', cancelListener);
      });
    }

    /**
     * Initialisiert Firebase und führt die Authentifizierung durch.
     */
    async function initFirebase() {
      try {
        setLogLevel('Debug');

        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        await setPersistence(auth, browserLocalPersistence);

        onAuthStateChanged(auth, async (user) => {
          if (user) {
            userId = user.uid;
            isAuthReady = true;

            await initWorkshopData(); // Initialisiert Daten für 'workshops_sa'
            listenForWorkshops(); // Startet Listener für 'workshops_sa'
            attachAdminEventListeners();
            attachMenuEventListeners(); // Event Listener für Menü hinzufügen
          } else {
            try {
              if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
              } else {
                await signInAnonymously(auth);
              }
            } catch (error) {
              console.error("Fehler bei der Authentifizierung:", error);
              isAuthReady = true;
            }
          }
        });

      } catch (error) {
        console.error("Fehler bei der Firebase-Initialisierung:", error);
      }
    }

    /**
     * Initialisiert statische Workshop-Dokumente, falls sie nicht existieren.
     * GEÄNDERT: Prüft jetzt auf 'workshops_sa'.
     */
    async function initWorkshopData() {
      // Diese Funktion nur ausführen, wenn wir auf der 'workshops_sa'-Seite sind
      if (currentCollectionId !== 'workshops_sa') {
        console.log(`Überspringe statische Daten-Initialisierung für Collection: ${currentCollectionId}`);
        return;
      }

      const path = getWorkshopsPath(); // Holt den Pfad für 'workshops_sa'
      for (const workshop of WORKSHOPS_STATIC_DATA) {
        const docRef = doc(db, path, workshop.id);

        try {
          const docSnap = await getDoc(docRef);

          if (!docSnap.exists()) {
            await setDoc(docRef, {
              title: workshop.title,
              date: workshop.date,
              location: workshop.location,
              color: 'bg-indigo-600', // Standardfarbe
              maxParticipants: workshop.maxParticipants,
              participants: []
            });
            console.log(`Workshop ${workshop.id} initial erstellt.`);
          } else {
            // Metadaten aktualisieren
            await updateDoc(docRef, {
              title: workshop.title,
              date: workshop.date,
              location: workshop.location,
              color: docSnap.data().color || 'bg-indigo-600',
              maxParticipants: workshop.maxParticipants
            });
            console.log(`Workshop ${workshop.id} Metadaten aktualisiert.`);
          }
        } catch (e) {
          console.error("Fehler bei Initialisierung/Aktualisierung des Workshop-Dokuments:", e);
        }
      }
      console.log("Workshop-Datenbank initialisiert und geprüft.");
    }


    /**
     * Rendert alle Workshop-Kacheln neu.
     */
    function renderWorkshops(workshops) {
      workshopsContainer.innerHTML = '';

      if (isAdmin) {
        adminPanel.classList.remove('hidden');
        adminStatusText.textContent = 'Admin Mode (Angemeldet)';
        adminLoginBtn.classList.replace('bg-gray-200', 'bg-yellow-400');
      } else {
        adminPanel.classList.add('hidden');
        adminStatusText.textContent = 'Admin Login';
        adminLoginBtn.classList.replace('bg-yellow-400', 'bg-gray-200');
      }

      if (workshops.length === 0) {
        workshopsContainer.innerHTML = `<p class="md:col-span-full text-center p-10 text-gray-500">Keine Einträge in dieser Kategorie gefunden. Ein Admin kann hier neue erstellen.</p>`;
        return;
      }

      // GEÄNDERT: Sortierung nur für 'workshops_sa' anwenden
      let workshopsToRender = workshops;
      if (currentCollectionId === 'workshops_sa') {
        const orderedWorkshops = WORKSHOPS_STATIC_DATA
          .map(staticW => workshops.find(dynW => dynW.id === staticW.id))
          .filter(w => w);

        const dynamicOnly = workshops.filter(dynW => !WORKSHOPS_STATIC_DATA.some(staticW => staticW.id === dynW.id));
        workshopsToRender = [...orderedWorkshops, ...dynamicOnly];
      }


      workshopsToRender.forEach(workshop => {
        const participantCount = workshop.participants ? workshop.participants.length : 0;
        const isFull = participantCount >= workshop.maxParticipants;

        const sortedParticipants = (workshop.participants || []).sort((a, b) => {
          const timeA = a.timestamp || 0;
          const timeB = b.timestamp || 0;
          return timeA - timeB;
        });

        const displayDate = formatDateForDisplay(workshop.date);

        const participantListHtml = sortedParticipants.map((p, index) => {
          const canDelete = p.id === userId || isAdmin;
          const deleteButton = canDelete ?
            `<button data-workshop-id="${workshop.id}" 
                                 data-participant-id="${p.id}"
                                 data-participant-name="${p.name}"
                                 data-participant-timestamp="${p.timestamp}"
                                 class="delete-btn text-rose-500 hover:text-rose-700 ml-2 p-1 rounded transition">
                             <i data-lucide="x" class="w-4 h-4"></i>
                         </button>` : '';

          return `
                        <li class="flex justify-between items-center py-2 border-b border-gray-100 last:border-b-0">
                            <span class="text-gray-700 font-medium truncate">${index + 1}. ${p.name}</span>
                            ${deleteButton}
                        </li>
                    `;
        }).join('');

        const card = document.createElement('div');
        card.className = 'bg-white rounded-xl shadow-xl overflow-hidden transform hover:scale-[1.01] transition duration-300 border-t-8 border-indigo-500 relative';

        card.innerHTML = `
                    ${isAdmin ? `
                        <div class="absolute top-3 right-3 flex space-x-2 z-10">
                            <button data-workshop-id="${workshop.id}" 
                                    data-workshop-title="${workshop.title}"
                                    data-workshop-date="${workshop.date}" 
                                    data-workshop-location="${workshop.location || ''}"
                                    data-workshop-capacity="${workshop.maxParticipants}"
                                    class="admin-edit-btn p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition shadow-md" title="Workshop bearbeiten">
                                <i data-lucide="pencil" class="w-4 h-4"></i>
                            </button>
                            <button data-workshop-id="${workshop.id}" 
                                    class="admin-delete-workshop-btn p-2 bg-red-500 text-white rounded-full hover:bg-red-600 transition shadow-md" title="Workshop löschen">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    ` : ''}

                    <div class="p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-1">${workshop.title}</h3>
                        
                        <p class="text-sm text-gray-500 mb-2 flex items-center font-medium">
                            <i data-lucide="calendar" class="w-4 h-4 mr-1"></i> ${displayDate}
                        </p>
                        <p class="text-sm text-gray-500 mb-4 flex items-center font-medium">
                            <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i> ${workshop.location || 'Ort unbekannt'}
                        </p>
                        
                        <div class="flex items-center justify-between p-3 mb-4 rounded-lg ${isFull ? 'bg-red-100 text-red-700' : 'bg-indigo-100 text-indigo-700'} font-semibold">
                            <div class="flex items-center">
                                <i data-lucide="users" class="w-5 h-5 mr-2"></i>
                                Teilnehmer:
                            </div>
                            <span>${participantCount} / ${workshop.maxParticipants}</span>
                        </div>
                        
                        <h4 class="text-lg font-bold text-gray-700 mb-2">Angemeldete Namen:</h4>
                        <ul class="list-none p-0 space-y-1 max-h-48 overflow-y-auto" id="list-${workshop.id}">
                            ${participantListHtml || '<li class="text-gray-400 italic">Noch keine Einträge.</li>'}
                        </ul>

                        <div class="mt-6 pt-4 border-t border-gray-100">
                            <h4 class="text-md font-bold text-gray-700 mb-3">Namen hinzufügen:</h4>
                            <div class="flex space-x-2">
                                <input type="text" 
                                    placeholder="Ihr Name (Enter zum Bestätigen)"
                                    id="input-${workshop.id}"
                                    class="add-input flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"
                                    ${isFull ? 'disabled' : ''}>
                                <button data-workshop-id="${workshop.id}"
                                    id="btn-${workshop.id}"
                                    class="add-btn px-4 py-2 text-white font-semibold rounded-lg shadow-md transition duration-200 ${isFull ? 'bg-gray-400 cursor-not-allowed' : 'bg-indigo-600 hover:bg-indigo-700'}">
                                    Eintragen
                                </button>
                            </div>
                            ${isFull ? '<p class="text-sm text-red-500 mt-2 font-medium">Dieser Workshop ist leider voll.</p>' : ''}
                            <p id="status-${workshop.id}" class="text-sm mt-2 font-medium"></p>
                        </div>
                    </div>
                `;
        workshopsContainer.appendChild(card);
      });

      lucide.createIcons();
      attachEventListeners();
    }

    /**
     * Erstellt einen Echtzeit-Listener für die gesamte Workshop-Sammlung.
     * Hebt den alten Listener auf (unsubscribe), bevor ein neuer
     * für die 'currentCollectionId' erstellt wird.
     */
    function listenForWorkshops() {
      if (!db || !isAuthReady) {
        return;
      }

      // Bestehenden Listener kündigen, falls vorhanden
      if (workshopListenerUnsubscribe) {
        workshopListenerUnsubscribe();
        workshopListenerUnsubscribe = null;
        console.log("Alter Listener gekündigt.");
      }

      const workshopsCol = collection(db, getWorkshopsPath());

      workshopListenerUnsubscribe = onSnapshot(workshopsCol, (snapshot) => {
        document.getElementById('loading-workshops')?.remove();

        const workshops = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        renderWorkshops(workshops);
      }, (error) => {
        console.error("Fehler beim Zuhören der Workshops: ", error);
        workshopsContainer.innerHTML = '<p class="md:col-span-full text-red-500 p-10">FEHLER beim Laden der Listen. Bitte Konsole prüfen.</p>';
      });
    }

    /**
     * Fügt Event-Listener für alle 'Eintragen'- und 'Löschen'-Buttons sowie Enter-Tasten hinzu.
     */
    function attachEventListeners() {
      // Eintragen-Buttons (Click-Handler)
      document.querySelectorAll('.add-btn').forEach(button => {
        button.onclick = null;
        button.onclick = async () => {
          const workshopId = button.getAttribute('data-workshop-id');
          const input = document.getElementById(`input-${workshopId}`);
          const name = input.value.trim();

          if (name) {
            await addParticipantToWorkshop(workshopId, name);
            input.value = '';
          } else {
            showMessage("Bitte geben Sie einen Namen ein.", true);
          }
        };
      });

      // Eintragen via Enter-Taste (Keyup-Handler)
      document.querySelectorAll('.add-input').forEach(input => {
        input.onkeyup = null; // Entferne vorherige Listener
        input.onkeyup = async (event) => {
          if (event.key === 'Enter') {
            const workshopId = input.id.replace('input-', '');
            const name = input.value.trim();

            if (name) {
              await addParticipantToWorkshop(workshopId, name);
              input.value = ''; // Eingabefeld nach Eintragung leeren
            } else {
              showMessage("Bitte geben Sie einen Namen ein.", true);
            }
          }
        };
      });


      // Löschen-Buttons
      document.querySelectorAll('.delete-btn').forEach(button => {
        button.onclick = null;
        button.onclick = async () => {
          const workshopId = button.getAttribute('data-workshop-id');

          const participantData = {
            name: button.getAttribute('data-participant-name'),
            id: button.getAttribute('data-participant-id'),
            timestamp: parseInt(button.getAttribute('data-participant-timestamp'), 10)
          };

          const confirmed = await showConfirmModal(`Soll der Eintrag "${participantData.name}" aus der Liste entfernt werden?`);

          if (confirmed) {
            await removeParticipantFromWorkshop(workshopId, participantData);
          }
        };
      });

      // Admin-Buttons (Edit/Delete Workshop)
      document.querySelectorAll('.admin-edit-btn').forEach(button => {
        button.onclick = null;
        button.onclick = () => {
          formId.value = button.getAttribute('data-workshop-id');
          formId.setAttribute('disabled', 'true');
          formTitle.value = button.getAttribute('data-workshop-title');
          formDate.value = button.getAttribute('data-workshop-date');
          formLocation.value = button.getAttribute('data-workshop-location');
          formCapacity.value = button.getAttribute('data-workshop-capacity');
          adminStatus.textContent = `Workshop '${formTitle.value}' wird bearbeitet. Teilnehmer bleiben erhalten.`;
          adminStatus.classList.remove('text-red-500', 'text-green-500');
          adminStatus.classList.add('text-indigo-500');
        };
      });

      document.querySelectorAll('.admin-delete-workshop-btn').forEach(button => {
        button.onclick = null;
        button.onclick = async () => {
          const workshopId = button.getAttribute('data-workshop-id');
          const confirmed = await showConfirmModal(`WARNUNG: Sind Sie sicher, dass Sie den Workshop ID: '${workshopId}' und ALLE seine Einträge unwiderruflich löschen möchten?`, true);

          if (confirmed) {
            await deleteWorkshop(workshopId);
          }
        };
      });
    }


    /**
     * Fügt einen Teilnehmer zur Liste eines Workshops hinzu.
     */
    async function addParticipantToWorkshop(workshopId, name) {
      if (!isAuthReady || !db) {
        showMessage("Warten Sie, bis die Datenbankverbindung hergestellt ist.", true);
        return;
      }

      const statusDisplay = document.getElementById(`status-${workshopId}`);
      const docRef = doc(db, getWorkshopsPath(), workshopId);

      statusDisplay.textContent = 'Speichere...';
      statusDisplay.classList.remove('text-red-500', 'text-green-500');
      statusDisplay.classList.add('text-indigo-500');

      try {
        const docSnap = await getDoc(docRef);
        if (!docSnap.exists()) {
          showMessage(`Fehler: Workshop-ID '${workshopId}' existiert nicht.`, true);
          statusDisplay.textContent = 'Fehler beim Eintragen.';
          statusDisplay.classList.replace('text-indigo-500', 'text-red-500');
          return;
        }

        const data = docSnap.data();
        const currentParticipants = data.participants || [];

        const lowerCaseName = name.toLowerCase();

        const nameExists = currentParticipants.some(p => p.name.toLowerCase() === lowerCaseName);

        if (nameExists) {
          showMessage(`Der Name "${name}" ist in diesem Workshop bereits eingetragen.`, true);
          statusDisplay.textContent = 'Name bereits eingetragen.';
          statusDisplay.classList.replace('text-indigo-500', 'text-red-500');
          return;
        }

        if (currentParticipants.length >= data.maxParticipants) {
          showMessage("Dieser Workshop ist leider voll.", true);
          statusDisplay.textContent = 'Workshop voll.';
          statusDisplay.classList.replace('text-indigo-500', 'text-red-500');
          return;
        }

        const newParticipant = {
          name: name,
          id: userId,
          timestamp: Date.now()
        };

        await updateDoc(docRef, {
          participants: arrayUnion(newParticipant)
        });

        statusDisplay.textContent = 'Erfolgreich eingetragen!';
        statusDisplay.classList.replace('text-indigo-500', 'text-green-500');

      } catch (error) {
        console.error(`Fehler beim Eintragen in Workshop ${workshopId}: `, error);
        showMessage(`Fehler beim Eintragen: ${error.message}`, true);
        statusDisplay.textContent = 'Fehler beim Speichern.';
        statusDisplay.classList.replace('text-indigo-500', 'text-red-500');
      }
    }

    /**
     * Entfernt einen Teilnehmer aus der Liste eines Workshops.
     */
    async function removeParticipantFromWorkshop(workshopId, participantObject) {
      if (!isAuthReady || !db) {
        showMessage("Warten Sie, bis die Datenbankverbindung hergestellt ist.", true);
        return;
      }

      if (participantObject.id !== userId && !isAdmin) {
        showMessage("Sie können nur Ihre eigenen Einträge löschen.", true);
        return;
      }

      const docRef = doc(db, getWorkshopsPath(), workshopId);

      try {
        await updateDoc(docRef, {
          participants: arrayRemove(participantObject)
        });
        showMessage(`Eintrag "${participantObject.name}" entfernt.`, false);

      } catch (error) {
        console.error(`Fehler beim Löschen aus Workshop ${workshopId}: `, error);
        showMessage(`Fehler beim Löschen: ${error.message}`, true);
      }
    }

    // ***************************************************************
    // ADMIN-FUNKTIONEN
    // ***************************************************************

    function openAdminLoginModal() {
      adminLoginModal.classList.remove('hidden');
      adminPasswordInput.value = '';
      adminLoginError.classList.add('hidden');
      adminPasswordInput.focus();
    }

    function handleAdminLogin() {
      const password = adminPasswordInput.value;
      if (password === ADMIN_PASSWORD) {
        isAdmin = true;
        adminLoginModal.classList.add('hidden');
        showMessage("Admin-Modus aktiviert.", false);
        listenForWorkshops(); // Neu rendern, um Admin-UI zu zeigen
      } else {
        adminLoginError.textContent = "Falsches Passwort.";
        adminLoginError.classList.remove('hidden');
      }
    }

    async function submitWorkshopForm(event) {
      event.preventDefault();

      const workshopId = formId.value.trim();
      const title = formTitle.value.trim();
      const date = formDate.value;
      const location = formLocation.value.trim();
      const capacity = parseInt(formCapacity.value, 10);

      if (!workshopId || !title || !date || isNaN(capacity) || capacity <= 0) {
        adminStatus.textContent = 'Fehler: ID, Titel, Datum und Max. Teilnehmer müssen gültig ausgefüllt sein.';
        adminStatus.classList.replace('text-indigo-500', 'text-red-500');
        return;
      }

      // Holt den Pfad der *aktuell* angezeigten Collection
      const docRef = doc(db, getWorkshopsPath(), workshopId);

      adminStatus.textContent = 'Speichere Workshop...';
      adminStatus.classList.remove('text-red-500', 'text-green-500');
      adminStatus.classList.add('text-indigo-500');

      try {
        const docSnap = await getDoc(docRef);
        const isNew = !docSnap.exists();
        const defaultColor = 'bg-indigo-500';

        const newWorkshopData = {
          title: title,
          date: date,
          location: location,
          maxParticipants: capacity,
          color: isNew ? defaultColor : docSnap.data().color || defaultColor,
        };

        if (isNew) {
          await setDoc(docRef, { ...newWorkshopData, participants: [] });
        } else {
          await updateDoc(docRef, newWorkshopData);
        }

        adminStatus.textContent = `Workshop '${title}' erfolgreich ${isNew ? 'erstellt' : 'aktualisiert'}.`;
        adminStatus.classList.replace('text-indigo-500', 'text-green-500');

        workshopForm.reset();
        formId.removeAttribute('disabled');
      } catch (e) {
        console.error("Fehler beim Speichern des Workshops:", e);
        adminStatus.textContent = `Fehler beim Speichern: ${e.message}`;
        adminStatus.classList.replace('text-indigo-500', 'text-red-500');
      }
    }

    async function deleteWorkshop(workshopId) {
      if (!isAdmin || !db) return;

      // Holt den Pfad der *aktuell* angezeigten Collection
      const docRef = doc(db, getWorkshopsPath(), workshopId);

      try {
        await deleteDoc(docRef);
        showMessage(`Workshop ID: '${workshopId}' wurde gelöscht.`, false);

        // GEÄNDERT: Prüfe, ob der gelöschte Workshop in der statischen Liste war
        if (currentCollectionId === 'workshops_sa') {
          const index = WORKSHOPS_STATIC_DATA.findIndex(w => w.id === workshopId);
          if (index > -1) {
            WORKSHOPS_STATIC_DATA.splice(index, 1);
          }
        }

      } catch (error) {
        console.error(`Fehler beim Löschen des Workshops ${workshopId}: `, error);
        showMessage(`Fehler beim Löschen des Workshops: ${error.message}`, true);
      }
    }

    function attachAdminEventListeners() {
      adminLoginBtn.onclick = openAdminLoginModal;
      adminModalCancelBtn.onclick = () => adminLoginModal.classList.add('hidden');
      adminModalConfirmBtn.onclick = handleAdminLogin;
      adminPasswordInput.onkeyup = (e) => {
        if (e.key === 'Enter') handleAdminLogin();
      };
      workshopForm.onsubmit = submitWorkshopForm;
    }

    // ***************************************************************
    // MENÜ-FUNKTIONEN
    // ***************************************************************

    /**
     * Öffnet das Seitenmenü.
     */
    function openMenu() {
      document.body.classList.add('menu-open');
    }

    /**
     * Schließt das Seitenmenü.
     */
    function closeMenu() {
      document.body.classList.remove('menu-open');
    }

    /**
     * Wechselt die angezeigte Workshop-Kollektion.
     */
    function switchCollection(newCollectionId) {
      if (newCollectionId === currentCollectionId) {
        closeMenu();
        return; // Nichts tun, wenn bereits aktiv
      }

      console.log(`Wechsle zu Collection: ${newCollectionId}`);
      currentCollectionId = newCollectionId;

      // Header-Texte anpassen
      document.getElementById('main-title').textContent = COLLECTION_TITLES[newCollectionId] || 'Workshops';
      document.getElementById('main-subtitle').textContent = COLLECTION_SUBTITLES[newCollectionId] || '';

      // Lade-Status anzeigen
      workshopsContainer.innerHTML = `
        <div id="loading-workshops" class="md:col-span-full text-center p-10 text-indigo-600 font-semibold">
          <div class="animate-spin inline-block w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mb-3" role="status"></div>
          <p>Lade ${COLLECTION_TITLES[newCollectionId]}...</p>
        </div>`;

      // Admin-Panel zurücksetzen (falls Admin eingeloggt ist)
      if (isAdmin) {
        adminPanel.classList.add('hidden'); // Kurz ausblenden, wird durch renderWorkshops wieder gezeigt
        workshopForm.reset();
        formId.removeAttribute('disabled');
        adminStatus.textContent = '';
      }

      // Daten-Initialisierung für die NEUE Collection prüfen (wird nur für 'workshops_sa' ausgeführt)
      initWorkshopData();

      // Listener für die NEUE Collection starten (kündigt automatisch den alten)
      listenForWorkshops();

      // Menü schließen
      closeMenu();
    }

    /**
     * Fügt die Event Listener für das Menü hinzu.
     * GEÄNDERT: 4 Menüpunkte
     */
    function attachMenuEventListeners() {
      menuOpenBtn.onclick = openMenu;
      menuOverlay.onclick = closeMenu;

      // Links im Menü
      menuLinkWorkshopsSa.onclick = () => switchCollection('workshops_sa');
      menuLinkWorkshopsSo.onclick = () => switchCollection('workshops_so');
      menuLinkSportSa.onclick = () => switchCollection('sport_sa');
      menuLinkSportSo.onclick = () => switchCollection('sport_so');
    }


    // Starte die Anwendung und initialisiere Firebase
    initFirebase();

    window.onload = () => {
      lucide.createIcons();
    };
  </script>
</body>

</html>